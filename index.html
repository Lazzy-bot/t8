<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Farm Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load E-Ra Widget th·∫≠t -->
  <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
  <style>
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; transition: 0.4s; border-radius: 28px;
    }
    .slider:before {
      position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px;
      background-color: white; transition: 0.4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: #3b82f6; }
    input:checked + .slider:before { transform: translateX(22px); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-4 md:p-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center tracking-wide">
      üå± H·ªá Th·ªëng Gi√°m S√°t N√¥ng Tr·∫°i Th√¥ng Minh
    </h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- C·∫£m bi·∫øn -->
      <div class="bg-white rounded-2xl shadow-lg p-5 hover:shadow-xl transition">
        <h2 class="text-xl font-bold text-blue-600 mb-2">Gi√°m S√°t M√¥i Tr∆∞·ªùng</h2>
        <p class="text-sm text-gray-500 mb-4">Theo d√µi th√¥ng s·ªë m√¥i tr∆∞·ªùng theo th·ªùi gian th·ª±c</p>
        <div class="space-y-3">
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div>
              <p class="text-sm text-gray-500">üå°Ô∏è Nhi·ªát ƒë·ªô</p>
              <p id="temperature" class="text-xl font-semibold">-- ¬∞C</p>
            </div>
          </div>
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div>
              <p class="text-sm text-gray-500">üíß ƒê·ªô ·∫©m</p>
              <p id="humidity" class="text-xl font-semibold">-- %</p>
            </div>
          </div>
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div>
              <p class="text-sm text-gray-500">üå± ƒê·ªô ·∫©m ƒë·∫•t</p>
              <p id="soilMoisture" class="text-xl font-semibold">-- %</p>
            </div>
          </div>
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div>
              <p class="text-sm text-gray-500">üìà Chi·ªÅu cao c√¢y</p>
              <p id="plantHeight" class="text-xl font-semibold">-- cm</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ƒêi·ªÅu khi·ªÉn -->
      <div class="space-y-6">
        <!-- T∆∞·ªõi -->
        <div class="bg-white rounded-2xl shadow-lg p-5 hover:shadow-xl transition">
          <h2 class="text-xl font-bold text-blue-600 mb-2">üí¶ ƒêi·ªÅu Khi·ªÉn T∆∞·ªõi Ti√™u</h2>
          <div class="flex items-center space-x-3 mb-3">
            <span class="text-gray-700 font-medium">Ch·∫ø ƒë·ªô t∆∞·ªõi:</span>
            <label class="switch">
              <input type="checkbox" id="irrigation-switch">
              <span class="slider"></span>
            </label>
            <span id="irrigation-label" class="text-sm text-gray-600">T·ª± ƒë·ªông</span>
          </div>

          <div id="irrigation-manual" class="hidden space-y-3">
            <label class="block text-sm">‚è±Ô∏è Th·ªùi gian t∆∞·ªõi: <span id="irrigation-time" class="font-semibold text-blue-600">10</span> gi√¢y</label>
            <input id="irrigation-duration" type="range" min="5" max="60" step="5" value="10" class="w-full accent-blue-600">
            <button id="btn-irrigate" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg transition">B·∫Øt ƒë·∫ßu t∆∞·ªõi</button>
          </div>

          <div id="irrigation-auto" class="p-3 bg-blue-50 rounded-lg">
            <p class="text-sm text-gray-600">H·ªá th·ªëng t·ª± ƒë·ªông t∆∞·ªõi khi ƒë·∫•t &lt; 40%</p>
          </div>
        </div>

        <!-- Ph√¢n b√≥n -->
        <div class="bg-white rounded-2xl shadow-lg p-5 hover:shadow-xl transition">
          <h2 class="text-xl font-bold text-green-600 mb-2">üåø ƒêi·ªÅu Khi·ªÉn Ph√¢n B√≥n</h2>
          <div class="flex items-center space-x-3 mb-3">
            <span class="text-gray-700 font-medium">Ch·∫ø ƒë·ªô b√≥n:</span>
            <label class="switch">
              <input type="checkbox" id="fertilizer-switch">
              <span class="slider"></span>
            </label>
            <span id="fertilizer-label" class="text-sm text-gray-600">T·ª± ƒë·ªông</span>
          </div>

          <div id="fertilizer-manual" class="hidden space-y-3">
            <label class="block text-sm">Ch·ªçn lo·∫°i ph√¢n:</label>
            <div class="flex space-x-2">
              <button id="btn-nitrogen" class="flex-1 border rounded p-2 hover:bg-green-100">ƒê·∫°m (N)</button>
              <button id="btn-phosphorus" class="flex-1 border rounded p-2 hover:bg-green-100">L√¢n (P)</button>
              <button id="btn-potassium" class="flex-1 border rounded p-2 hover:bg-green-100">Kali (K)</button>
            </div>
            <label class="block text-sm">‚è±Ô∏è Th·ªùi gian b√≥n: <span id="fertilizer-time" class="font-semibold text-green-600">5</span> gi√¢y</label>
            <input id="fertilizer-duration" type="range" min="3" max="20" step="1" value="5" class="w-full accent-green-600">
            <button id="btn-fertilize" class="w-full bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg transition">B√≥n ph√¢n</button>
          </div>

          <div id="fertilizer-auto" class="p-3 bg-green-50 rounded-lg">
            <p class="text-sm text-gray-600">H·ªá th·ªëng t·ª± ƒë·ªông b√≥n ph√¢n theo l·ªãch.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Tr·∫°ng th√°i h·ªá th·ªëng -->
    <div class="bg-white rounded-2xl shadow-lg p-5 mt-6 hover:shadow-xl transition">
      <h2 class="text-xl font-bold text-indigo-600">üì° Tr·∫°ng Th√°i H·ªá Th·ªëng</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
        <div class="flex flex-col items-center p-3 bg-gray-50 rounded-lg">
          <div id="status-irrigation" class="w-4 h-4 rounded-full bg-gray-300 mb-2"></div>
          <span class="text-sm">T∆∞·ªõi ti√™u</span>
        </div>
        <div class="flex flex-col items-center p-3 bg-gray-50 rounded-lg">
          <div id="status-fertilizer" class="w-4 h-4 rounded-full bg-gray-300 mb-2"></div>
          <span class="text-sm">B√≥n ph√¢n</span>
        </div>
        <div class="flex flex-col items-center p-3 bg-gray-50 rounded-lg">
          <div id="status-connection" class="w-4 h-4 rounded-full bg-gray-300 mb-2"></div>
          <span class="text-sm">K·∫øt n·ªëi</span>
        </div>
        <div class="flex flex-col items-center p-3 bg-gray-50 rounded-lg">
          <div id="status-power" class="w-4 h-4 rounded-full bg-gray-300 mb-2"></div>
          <span class="text-sm">Ngu·ªìn ƒëi·ªán</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const eraWidget = new EraWidget();
    let realtimeConfigs = new Array(4).fill(null);
    let actionConfigs = new Array(9).fill(null);
    let isConfigured = false;

    let irrigationMode = "auto";
    let fertilizerMode = "auto";
    let irrigationDuration = 10;
    let fertilizerDuration = 5;
    let fertilizers = {nitrogen: false, phosphorus: false, potassium: false};
    let isIrrigating = false;
    let isFertilizing = false;

    const sensorMap = ['temperature', 'humidity', 'soilMoisture', 'plantHeight'];
    const sensorUnits = ['¬∞C', '%', '%', 'cm'];

    const pinMap = {
      irrigation: 0,     // V4
      irrigate: 1,       // V5
      fertilizer: 2,     // V6
      nitrogen: 4,       // Adjusted from 3 to 4 (V8, shifted due to insertion)
      phosphorus: 5,     // Adjusted from 4 to 5 (V9, shifted)
      potassium: 6,      // Adjusted from 5 to 6 (V10, shifted)
      fertilize: 7,      // Adjusted from 6 (not used, but shifted for consistency)
      irrigationDuration: 7,  // V11 (kept as is)
      fertilizerDuration: 8   // V12 (kept as is)
    };

    function setIndicator(id, active) {
      const el = document.getElementById(id);
      if (el) el.className = "w-4 h-4 rounded-full mb-2 " + (active ? "bg-green-500" : "bg-gray-300");
    }

    function updateSensorDisplay(index, value) {
      if (index >= 0 && index < sensorMap.length && value !== null && !isNaN(value)) {
        const el = document.getElementById(sensorMap[index]);
        if (el) el.textContent = value.toFixed(1) + " " + sensorUnits[index];
      }
    }

    function updateButtonState(buttonId, state) {
      switch(buttonId) {
        case 'irrigation':
          irrigationMode = state ? "manual" : "auto";
          document.getElementById('irrigation-label').textContent = irrigationMode === "auto" ? "T·ª± ƒë·ªông" : "Th·ªß c√¥ng";
          document.getElementById('irrigation-manual').style.display = state ? 'block' : 'none';
          document.getElementById('irrigation-auto').style.display = !state ? 'block' : 'none';
          break;
        case 'fertilizer':
          fertilizerMode = state ? "manual" : "auto";
          document.getElementById('fertilizer-label').textContent = fertilizerMode === "auto" ? "T·ª± ƒë·ªông" : "Th·ªß c√¥ng";
          document.getElementById('fertilizer-manual').style.display = state ? 'block' : 'none';
          document.getElementById('fertilizer-auto').style.display = !state ? 'block' : 'none';
          break;
        default:
          if(buttonId in fertilizers) fertilizers[buttonId] = state;
      }
    }

    function sendDuration(buttonId, duration) {
      const pinIndex = pinMap[buttonId + 'Duration'];
      if (pinIndex !== undefined && isConfigured) {
        const config = actionConfigs[pinIndex];
        if (config) eraWidget.triggerAction(config.action, 0, {value: duration});
      }
    }

    function controlButton(buttonId, state) {
      updateButtonState(buttonId, state);

      // Kh√¥ng trigger hardware cho irrigation/fertilizer mode n·ªØa, ch·ªâ update UI local
      // if ((buttonId === 'irrigation' || buttonId === 'fertilizer') && isConfigured) {
      //   const pinIndex = pinMap[buttonId];
      //   const config = actionConfigs[pinIndex];
      //   if(config) eraWidget.triggerAction(config.action, 0, {value: state ? 1 : 0});
      // }

      if (buttonId === 'irrigate') {
        const pinIndex = pinMap['irrigate'];
        const config = actionConfigs[pinIndex];
        if(state) {
          isIrrigating = true;
          setIndicator("status-irrigation", true);
          if(isConfigured && config) eraWidget.triggerAction(config.action, 0, {value:1});
          setTimeout(()=>controlButton('irrigate', false), irrigationDuration*1000);
        } else {
          isIrrigating = false;
          setIndicator("status-irrigation", false);
          if(isConfigured && config) eraWidget.triggerAction(config.action, 0, {value:0});
        }
      }

      // Lo·∫°i b·ªè x·ª≠ l√Ω cho 'fertilize' v√¨ gi·ªù x·ª≠ l√Ω ri√™ng trong onclick
    }

    function toggleFert(key) {
      if(fertilizerMode !== "manual") return;
      const current = fertilizers[key];
      fertilizers[key] = !current;
      const el = document.getElementById('btn-' + key);
      if(el) {
        if(!current) el.classList.add('bg-green-500', 'text-white');
        else el.classList.remove('bg-green-500', 'text-white');
      }
      // Kh√¥ng trigger action ngay, ch·ªâ update UI v√† state local
    }

    function resetAllRelays() {
      // Reset irrigation relay to OFF
      controlButton('irrigate', false);

      // Reset all fertilizer relays to OFF
      ['nitrogen', 'phosphorus', 'potassium'].forEach(key => {
        const pinIndex = pinMap[key];
        const config = actionConfigs[pinIndex];
        if (isConfigured && config) {
          eraWidget.triggerAction(config.action, 0, {value: 0});
        }
      });

      // Reset UI for fertilizer buttons
      ['nitrogen', 'phosphorus', 'potassium'].forEach(key => {
        const el = document.getElementById('btn-' + key);
        if (el) {
          el.classList.remove('bg-green-500', 'text-white');
        }
      });

      // Reset states
      Object.keys(fertilizers).forEach(key => fertilizers[key] = false);
      isFertilizing = false;
      setIndicator("status-fertilizer", false);
    }

    eraWidget.init({
      onConfiguration: (cfg) => {
        cfg.realtime_configs.slice(0,4).forEach((c,i)=>realtimeConfigs[i]=c);
        cfg.actions.slice(0,9).forEach((c,i)=>actionConfigs[i]=c);
        isConfigured = true;
        updateButtonState('irrigation', false);
        updateButtonState('fertilizer', false);
        setIndicator("status-connection", true);
        setIndicator("status-power", true);

        // Reset all relays to OFF on configuration to fix "s√°ng m√£i" issue
        resetAllRelays();
      },
      onValues: (values) => {
        realtimeConfigs.forEach((c,i)=>{if(c && values[c.id]) updateSensorDisplay(i,values[c.id].value)});
        const soilValue = parseFloat(document.getElementById('soilMoisture').textContent);
        if(!isNaN(soilValue) && irrigationMode==="auto" && soilValue<40 && !isIrrigating){
          console.log("Auto irrigation triggered");
          sendDuration('irrigation', irrigationDuration);
          controlButton('irrigate', true);
        }
      },
      needRealtimeConfigs:true,
      needActions:true,
      ready:true
    });

    document.getElementById("irrigation-switch").addEventListener("change", e=>controlButton('irrigation', e.target.checked));
    document.getElementById("fertilizer-switch").addEventListener("change", e=>controlButton('fertilizer', e.target.checked));
    ["nitrogen","phosphorus","potassium"].forEach(k=>document.getElementById("btn-"+k).addEventListener("click", ()=>toggleFert(k)));

    document.getElementById("btn-irrigate").onclick = ()=>{
      if(irrigationMode!=="manual") return;
      sendDuration('irrigation', irrigationDuration);
      controlButton('irrigate', true);
    };

    document.getElementById("btn-fertilize").onclick = ()=>{
      if(fertilizerMode!=="manual") return;
      const selectedFertilizers = { ...fertilizers }; // Capture current selections
      const selectedKeys = Object.keys(selectedFertilizers).filter(k => selectedFertilizers[k]);
      if (selectedKeys.length === 0) return; // Optional: don't proceed if nothing selected

      sendDuration('fertilizer', fertilizerDuration);

      // Trigger ON for selected relays
      selectedKeys.forEach(key => {
        const pinIndex = pinMap[key];
        const config = actionConfigs[pinIndex];
        if (isConfigured && config) {
          eraWidget.triggerAction(config.action, 0, {value: 1});
        }
      });

      isFertilizing = true;
      setIndicator("status-fertilizer", true);

      // Auto OFF after duration
      setTimeout(() => {
        // Trigger OFF for selected relays
        selectedKeys.forEach(key => {
          const pinIndex = pinMap[key];
          const config = actionConfigs[pinIndex];
          if (isConfigured && config) {
            eraWidget.triggerAction(config.action, 0, {value: 0});
          }
        });

        isFertilizing = false;
        setIndicator("status-fertilizer", false);
      }, fertilizerDuration * 1000);
    };

    document.getElementById("irrigation-duration").addEventListener("input", e=>{
      irrigationDuration = Math.max(+e.target.value,5);
      document.getElementById("irrigation-time").textContent = irrigationDuration;
    });

    document.getElementById("fertilizer-duration").addEventListener("input", e=>{
      fertilizerDuration = Math.max(+e.target.value,3);
      document.getElementById("fertilizer-time").textContent = fertilizerDuration;
    });
  </script>
</body>
</html>